#!/bin/bash

# Function to get available fonts
get_available_fonts() {
    fc-list :family | sort -u | awk -F: '{print $2}' | sed 's/,//g' | sed 's/^[ 	]*//;s/[ 	]*$//' | grep -v "^$"
}

# Function to apply font to Alacritty
apply_font_alacritty() {
    local font_name="$1"
    local config_file="$HOME/.config/alacritty/alacritty.toml"
    if [ -f "$config_file" ]; then
        sed -i "s/^font = { family = \".*\", style = \".*\" }/font = { family = \"$font_name\", style = \"Regular\" }/" "$config_file"
        sed -i "s/^normal = { family = \".*\", style = \".*\" }/normal = { family = \"$font_name\", style = \"Regular\" }/" "$config_file"
        sed -i "s/^bold = { family = \".*\", style = \".*\" }/bold = { family = \"$font_name\", style = \"Bold\" }/" "$config_file"
        sed -i "s/^italic = { family = \".*\", style = \".*\" }/italic = { family = \"$font_name\", style = \"Italic\" }/" "$config_file"
        echo "Font '$font_name' applied to Alacritty. Restart Alacritty to see changes."
    else
        echo "Alacritty config file not found: $config_file" >&2
    fi
}

# Function to apply font to Kitty
apply_font_kitty() {
    local font_name="$1"
    local config_file="$HOME/.config/kitty/kitty.conf"
    if [ -f "$config_file" ]; then
        sed -i "s/^font_family .*/font_family $font_name/" "$config_file"
        echo "Font '$font_name' applied to Kitty. Restart Kitty to see changes."
    else
        echo "Kitty config file not found: $config_file" >&2
    fi
}

# Function to apply font to Waybar
apply_font_waybar() {
    local font_name="$1"
    local config_file="$HOME/.config/waybar/style.css" # Assuming font is set in CSS
    if [ -f "$config_file" ]; then
        sed -i "s/font-family: \".*\";/font-family: \"$font_name\";/" "$config_file"
        echo "Font '$font_name' applied to Waybar. Restart Waybar to see changes."
    else
        echo "Waybar style.css not found: $config_file" >&2
    fi
}

# Function to apply font to GTK (Nautilus, etc.)
apply_font_gtk() {
    local font_name="$1"
    local config_file_3="$HOME/.config/gtk-3.0/settings.ini"
    local config_file_4="$HOME/.config/gtk-4.0/settings.ini"
    
    if [ -f "$config_file_3" ]; then
        sed -i "s/^gtk-font-name=.*/gtk-font-name=$font_name 10/" "$config_file_3"
        echo "Font '$font_name' applied to GTK3 apps. Restart apps to see changes."
    else
        echo "GTK3 config file not found: $config_file_3" >&2
    fi

    if [ -f "$config_file_4" ]; then
        sed -i "s/^gtk-font-name=.*/gtk-font-name=$font_name 10/" "$config_file_4"
        echo "Font '$font_name' applied to GTK4 apps. Restart apps to see changes."
    else
            echo "GTK4 config file not found: $config_file_4" >&2
            fi
        }
        
        # Function to apply font system-wide (Fontconfig, GTK)
        apply_font_systemwide() {
            local font_name="        "
            local fontconfig_file="$HOME/.config/fontconfig/fonts.conf"
            local gtk3_file="$HOME/.config/gtk-3.0/settings.ini"
            local gtk4_file="$HOME/.config/gtk-4.0/settings.ini"
        
            # Update fontconfig
            if [ -f "$fontconfig_file" ]; then
                sed -i "s|<string>monospace</string>|<string>$font_name</string>|" "$fontconfig_file"
                sed -i "s|<string>sans-serif</string>|<string>$font_name</string>|" "$fontconfig_file"
                sed -i "s|<string>serif</string>|<string>$font_name</string>|" "$fontconfig_file"
                echo "Font '$font_name' applied to fontconfig. Run 'fc-cache -fv' and restart apps to see changes."
            else
                echo "Fontconfig file not found: $fontconfig_file" >&2
            fi
        
            # Update GTK3
            if [ -f "$gtk3_file" ]; then
                sed -i "s/^gtk-font-name=.*/gtk-font-name=$font_name 10/" "$gtk3_file"
                echo "Font '$font_name' applied to GTK3 apps. Restart apps to see changes."
            else
                echo "GTK3 config file not found: $gtk3_file" >&2
            fi
        
            # Update GTK4
            if [ -f "$gtk4_file" ]; then
                sed -i "s/^gtk-font-name=.*/gtk-font-name=$font_name 10/" "$gtk4_file"
                echo "Font '$font_name' applied to GTK4 apps. Restart apps to see changes."
            else
                echo "GTK4 config file not found: $gtk4_file" >&2
            fi
        }
        
        # Main script logic
        available_fonts=$(get_available_fonts)
        
        if [ -z "$available_fonts" ]; then
            echo "No fonts found. Please install fonts first." >&2
            exit 1
        fi
        
        selected_font=$(echo -e "$available_fonts" | fuzzel -d -p "Select a font: ")
        
        if [ -z "$selected_font" ]; then
            echo "No font selected."
            exit 0
        fi
        
        app_options=(
            "Alacritty" "apply_font_alacritty"
            "Kitty" "apply_font_kitty"
            "Waybar" "apply_font_waybar"
            "GTK Apps (Nautilus, etc.)" "apply_font_gtk"
            "System-wide (Fontconfig, GTK)" "apply_font_systemwide"
        )
        
        app_fuzzel_options=""
        for ((i=0; i<${#app_options[@]}; i+=2)); do
            app_fuzzel_options+="${app_options[i]}\n"
        done
        
        selected_app=$(echo -e "$app_fuzzel_options" | fuzzel -d -p "Apply '$selected_font' to which application? ")
        
        if [ -n "$selected_app" ]; then
            for ((i=0; i<${#app_options[@]}; i+=2)); do
                if [[ "$selected_app" == "${app_options[i]}" ]]; then
                    ${app_options[i+1]} "$selected_font"
                    exit 0
                fi
            done
        else
            echo "No application selected."
        fi
